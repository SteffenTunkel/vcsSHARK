# check if tests succeed
sudo: required
language: python
python:
  - "3.6"

services:
  - mongodb

before_install:
  - printenv | grep -E '^TRAVIS_' > .env
  # Create libgit2 library in separate folder, otherwise it overwrites our makefile
  - mkdir libgit2
  - cd libgit2
  - wget https://github.com/libgit2/libgit2/archive/v0.26.2.tar.gz
  - tar xzf v0.26.2.tar.gz
  - cmake libgit2-0.26.2/
  - make
  - sudo make install
  - cd ..
  # --- libit2 install finished ---
  - sudo apt-get install -y build-essential wget git
  - sudo apt-get install -y python3-pip python3-cffi
  - pip install -U pip setuptools
  - pip install Sphinx
  - pip install sphinx_rtd_theme

install:
  - python setup.py install
  - sudo ldconfig

script:
  - python setup.py test
  - make html

after_success:
  - cd plugin_packaging && ./build_plugin.sh && cd ..

deploy:
  - provider: pypi
    user: smartshark
    password:
      secure: DRjXhpbwxOLEEjMnt2qk3t92cEQ0SL+sQ3oO0kRq4PK4g3ZOSvuo9MsgVHW7/FjSqAHHhAE/SLf7o2mwywRAeS2njHiVE3I/07Bxby+7l3ABToMRG8ASjsLPEPS+oHaFvliXBETk7ljiyj8XzmxjmTahLFSh3E9+V4g/A2iwvwB5ibF2JETapR6DfF7QZfyNZ8q2QkpHONQ7kpNxcLi/ilvx8Soo5G8BRuUKRMB1O6IANA+OrYlb8YzW6P2CBcL+cCJrkrnFO5fx9c3INcJfVd4ZxN4tYrYHzbRP9SVPUVr54nFRGUbIpR0lAkFGrGpEQpFOM4knwSYHrN3D277gU4MJ56+GS9J5dabMFHv5PLgRDTtDv9P2txcEWBufx4P7s0ouenngPV5Uz3SCMc1J9WuUxxMz3q9KDUHIl1XMN3NmuLWc6mhy9rupRKlHJe7kwgl4iOW/llL35sVArENp15cHvbXCkn4BuP4AMu0UcNdP+Z5Wg3HKmRJKq6CktB7IgCHqcuAuxi4Noe+11jbii4R9KgWdzgfR0kra8uvNZZXcICa+IArVFAGiz4k1kgaFcxHMcqrblfYtM0UOogjAlPudElU+iUO2MZxafjte8qmmpUmotSiALwnWrFPbFg7ON78ks1lsYZPjcNt2iwyyRSZCk6qx5x0Tnyik/VhPlYw=
    on:
      tags: true
  - provider: releases
    api_key: ${GH_TOKEN}
    file: "plugin_packaging/vcsSHARK_plugin.tar"
    skip_cleanup: true
    on:
      repo: smartshark/vcsSHARK
      tags: true
  - provider: pages
    github-token: $(GH_TOKEN}
    local-dir: $TRAVIS_BUILD_DIR/docs/build
    skip_cleanup: true
    on:
      branch: master
