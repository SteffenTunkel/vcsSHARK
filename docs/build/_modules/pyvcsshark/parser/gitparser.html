

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyvcsshark.parser.gitparser &mdash; vcsSHARK 0.1a1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="vcsSHARK 0.1a1 documentation" href="../../../index.html"/>
        <link rel="up" title="pyvcsshark" href="../../pyvcsshark.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> vcsSHARK
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">2. API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">vcsSHARK</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../pyvcsshark.html">pyvcsshark</a> &raquo;</li>
      
    <li>pyvcsshark.parser.gitparser</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyvcsshark.parser.gitparser</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">pyvcsshark.parser.baseparser</span> <span class="kn">import</span> <span class="n">BaseParser</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">pygit2</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">pyvcsshark.dbmodels.models</span> <span class="kn">import</span> <span class="n">BranchModel</span><span class="p">,</span> <span class="n">PeopleModel</span><span class="p">,</span> <span class="n">TagModel</span><span class="p">,</span>\
    <span class="n">FileModel</span><span class="p">,</span> <span class="n">CommitModel</span>

<div class="viewcode-block" id="GitParser"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser">[docs]</a><span class="k">class</span> <span class="nc">GitParser</span><span class="p">(</span><span class="n">BaseParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parser for git repositories. The general parsing process is described in :func:`pyvcsshark.parser.gitparser.GitParser.parse`.</span>
<span class="sd">    </span>
<span class="sd">    :property SIMILARITY_THRESHOLD: sets the threshold for deciding if a file is similar to another. Default: 50%</span>
<span class="sd">    :property NUMBER_OF_PROCESSES: number of processes for the parsing process. Calls :func:`multiprocessing.cpu_count()`.</span>
<span class="sd">    :property repository: object of class :class:`pygit2.Repository`, which represents the repository</span>
<span class="sd">    :property commitsToBeProcessed: dictionary that is set up the following way: \</span>
<span class="sd">    commitsToBeProcessed = {&#39;&lt;revisionHash&gt;&#39; : {&#39;branches&#39; : set(), &#39;tags&#39; : []}}, where &lt;revisionHash&gt; must be replaced with the actual hash. Therefore, \</span>
<span class="sd">    this dictionary holds information about every revision and which branches this revision belongs to and which tags it has.</span>
<span class="sd">        </span>
<span class="sd">    :property logger: logger, which is acquired via logging.getLogger(&quot;parser&quot;)</span>
<span class="sd">    :property datastore: datestore, where the commits should be saved to</span>
<span class="sd">    :property commitqueue: object of class :class:`multiprocessing.JoinableQueue`, where commits are stored in that can be parsed</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Includes rename and copy threshold, 50% is the default git threshold</span>
    <span class="n">SIMILARITY_THRESHOLD</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">NUMBER_OF_PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;parser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="bp">None</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">commitQueue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>
        
    <span class="nd">@property</span>   
    <span class="k">def</span> <span class="nf">repositoryType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;git&#39;</span>
    
<div class="viewcode-block" id="GitParser.getProjectName"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.getProjectName">[docs]</a>    <span class="k">def</span> <span class="nf">getProjectName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the name of the project, which is processed&quot;&quot;&quot;</span>
        <span class="n">remoteURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProjectURL</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">remoteURL</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.git&quot;</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">lastPart</span> <span class="o">=</span> <span class="n">remoteURL</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lastPart</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">remoteURL</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitParser.getProjectURL"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.getProjectURL">[docs]</a>    <span class="k">def</span> <span class="nf">getProjectURL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the url of the project, which is processed &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">remotes</span><span class="p">[</span><span class="s">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">url</span></div>
        
        
    <span class="c">#def initialize(self):</span>
    <span class="c">#    &quot;&quot;&quot;Initialization process for parser&quot;&quot;&quot;</span>
    <span class="c">#    return</span>
    
<div class="viewcode-block" id="GitParser.finalize"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalization process for paser&quot;&quot;&quot;</span>
        <span class="k">return</span></div>
  
<div class="viewcode-block" id="GitParser.detect"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.detect">[docs]</a>    <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repositoryPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to detect the repository, if its not there an exception is raised and therfore false can be returned&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pathToRepository</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">discover_repository</span><span class="p">(</span><span class="n">repositoryPath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span><span class="n">pathToRepository</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="GitParser.addBranch"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.addBranch">[docs]</a>    <span class="k">def</span> <span class="nf">addBranch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commitHash</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Does two things: First it adds the commitHash to the commitqueue, so that the parsing processes can process this commit. Second it</span>
<span class="sd">        creates objects of type :class:`pyvcsshark.dbmodels.models.BranchModel` and stores it in the dictionary.</span>
<span class="sd">        </span>
<span class="sd">        :param commitHash: revision hash of the commit to be processed</span>
<span class="sd">        :param branch: branch that should be added for the commit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strCommitHash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">commitHash</span><span class="p">)</span>
        
        <span class="n">branchModel</span> <span class="o">=</span> <span class="n">BranchModel</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
        
        <span class="c"># If the commit is already in the dict, we only need to append the branch (because then it was already parsed)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strCommitHash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">strCommitHash</span><span class="p">][</span><span class="s">&#39;branches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">branchModel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commitQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">strCommitHash</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">strCommitHash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                           <span class="s">&#39;branches&#39;</span> <span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="n">branchModel</span><span class="p">]),</span>
                                           <span class="s">&#39;tags&#39;</span> <span class="p">:</span> <span class="p">[]</span>
                                           <span class="p">}</span></div>

<div class="viewcode-block" id="GitParser.addTag"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.addTag">[docs]</a>    <span class="k">def</span> <span class="nf">addTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taggedCommit</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">tagObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates objects of type :class:`pyvcsshark.dbmodels.models.TagModel` and stores it in the dictionary mentioned above. </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :param taggedCommit: revision hash of the commit to be processed</span>
<span class="sd">        :param tagName: name of the tag that should be added</span>
<span class="sd">        :param tagObject: in git it is possible to annotate tags. If a tag is annottated, we get a tag object of class :class:`pygit2.Tag`</span>

<span class="sd">        </span>
<span class="sd">        .. NOTE:: It can happen, that people committed to a tag and therefore created \</span>
<span class="sd">        a &quot;tag-branch&quot; which is normally not possible in git. Therefore, we go through all tags and check \</span>
<span class="sd">        if they respond to a commit, which is already in the dictionary. \</span>
<span class="sd">        If **yes** -&gt; we **tag** that commit \</span>
<span class="sd">        If **no** -&gt; we **ignore** it</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">commitId</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">taggedCommit</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        
        <span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
        
        <span class="k">if</span><span class="p">(</span><span class="n">commitId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">):</span>
            
            <span class="c"># If we have an annotated tag, get all the information we can out of it</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tagObject</span><span class="p">,</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Tag</span><span class="p">)):</span>
                <span class="n">peopleModel</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">tagObject</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tagObject</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                <span class="n">tagModel</span> <span class="o">=</span> <span class="n">TagModel</span><span class="p">(</span><span class="n">tagName</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagObject</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">peopleModel</span><span class="p">,</span>  <span class="n">tagObject</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">tagObject</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tagModel</span> <span class="o">=</span> <span class="n">TagModel</span><span class="p">(</span><span class="n">tagName</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">commitId</span><span class="p">][</span><span class="s">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tagModel</span><span class="p">)</span></div>

          
<div class="viewcode-block" id="GitParser.initialize"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializes the parser. It gets all the branch and tag information and puts it into two different locations: First the commit id</span>
<span class="sd">        is put into the commitqueue for the processing with the parsing processes. Second a dictionary is created, which holds the information of</span>
<span class="sd">        which branches a commit is on and which tags it has</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Get all references (branches, tags)</span>
        <span class="n">references</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">listall_references</span><span class="p">())</span>
        
        <span class="c"># Get all tags</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^refs/tags&#39;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">listall_references</span><span class="p">()))</span>
        
        <span class="c"># Get all branches</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">references</span><span class="o">-</span><span class="n">tags</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Getting branch information...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Getting information from branch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">branch</span><span class="p">))</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span><span class="o">.</span><span class="n">peel</span><span class="p">()</span>
            <span class="c"># Walk through every child</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                              <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TIME</span> <span class="o">|</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TOPOLOGICAL</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBranch</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Getting tags...&quot;</span><span class="p">)</span>
    
        <span class="c"># Walk through every tag and put the information in the dictionary via the addtag method</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">tagObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">[</span><span class="n">reference</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hex</span><span class="p">]</span>
            <span class="n">taggedCommit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">peel</span><span class="p">()</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">taggedCommit</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">tagObject</span><span class="p">)</span></div>


               
        
            
<div class="viewcode-block" id="GitParser.parse"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repositoryPath</span><span class="p">,</span> <span class="n">datastore</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses the repository, which is located at the repositoryPath and save the parsed commits in the</span>
<span class="sd">        datastore, by calling the :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` method of the chosen datastore. It</span>
<span class="sd">        mostly uses pygit2 (see: http://www.pygit2.org/).</span>
<span class="sd">        </span>
<span class="sd">        The parsing process is divided into several steps:</span>
<span class="sd">        </span>
<span class="sd">            1. A list of all branches and tags are created</span>
<span class="sd">            2. All branches and tags are parsed. So we create dictionary of all commits with their corresponding tags and branches and add all \</span>
<span class="sd">        revision hashes to the commitqueue</span>
<span class="sd">            3. Add the poison pills for terminating of the parsing process to the commitqueue</span>
<span class="sd">            4. Create processes of class :class:`pyvcsshark.parser.gitparser.CommitParserProcess`, which parse all commits.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="n">datastore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting parsing process...&quot;</span><span class="p">)</span>
        
        <span class="c"># Set up the poison pills</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commitQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        
        <span class="c"># Parsing all commits of the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Parsing commits...&quot;</span><span class="p">)</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">):</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">CommitParserProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commitQueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">commitQueue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Parsing complete...&quot;</span><span class="p">)</span>
     
        <span class="c"># Linux &quot;tests&quot;</span>
        <span class="c">#print(self.commitsToBeProcessed[&#39;73796d8bf27372e26c2b79881947304c14c2d353&#39;])        </span>
        <span class="c">#print(self.commitsToBeProcessed[&#39;9b29c6962b70f232cde4076b1020191e1be0889d&#39;])    </span>
        <span class="c">#print(self.commitsToBeProcessed[&#39;6a13feb9c82803e2b815eca72fa7a9f5561d7861&#39;]) # 4.3  </span>
        <span class="c">#print(self.commitsToBeProcessed[&#39;b953c0d234bc72e8489d3bf51a276c5c4ec85345&#39;]) # 4.1</span>
        <span class="c">#print(len(self.commitsToBeProcessed))  </span>
        
        <span class="c"># Samba &quot;tests&quot;      </span>
        <span class="c">#print(self.commits[&#39;5f9d3113d73bf87de16d909273dc6eb8c4cc98de&#39;]) # only v4-2-test branch</span>
        <span class="c">#print(self.commits[&#39;a6f9a793d8b14b9b77729fdeeea34287dd3bda3b&#39;]) # 4-2-test and v4-2-stable</span>
        <span class="c">#print(self.commits[&#39;392b2d33f243d1c9e25b7c48a38977cfe9924305&#39;]) # v4-3-test</span>
        <span class="c">#print(self.commits[&#39;c7207e73b116b76f6dd681e0c5a872ae2e702616&#39;]) # v4-3-test, master, v4-3-stable + tag tdb-1.3.7</span>
        <span class="c">#print(self.commits[&#39;8c8cbd984f8d1f30c7f2dfe3a4d3b472e3245aee&#39;]) # same as above + tag samba-4.3.0rc1</span>
        
        <span class="c"># Checkstyle &quot;tests&quot;</span>
        <span class="c">#print(self.commits[&#39;3fb7ae8ee60c30f1ad4a5b4b2ad0325075fef6ac&#39;]) # tag: release4_4</span>
        <span class="c">#print(self.commits[&#39;e2f1c7db68501d767a12fc5d99a14dd036ce400b&#39;]) # branch: build-helper-maven-plugin-1-10 + master</span>
        <span class="c">#print(self.commits[&#39;0bf5f793206ca5e219e19b4379f6d46221fe2aea&#39;]) # branch: build-helper-maven-plugin-1-10 + master</span>
        <span class="c">#print(self.commits[&#39;75989a70bbe0f6f319e7c250b9b10c5b51b8486d&#39;]) # branch: i2604-name-checks-format</span>
        <span class="c">#print(self.commits[&#39;9817c4fb3c1729772956bb9d37b549e823f4ffba&#39;]) # branch: i2604-name-checks-format</span>
        <span class="c">#print(self.commits[&#39;f52306ff7799ea2b2e4d99fba7040a11b186d68a&#39;]) # branch: i2604-name-checks-format + master + build-helper</span>
        <span class="c">#print(self.commits[&#39;753bc06c7aa24cb6be8d23afb6b4dc5cf4b5caea&#39;]) # branch: master, tag: checkstyle-6.12.1</span>
        
        <span class="c">#print(len(self.commits))</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="CommitParserProcess"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess">[docs]</a><span class="k">class</span> <span class="nc">CommitParserProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A process, which inherits from :class:`multiprocessing.Process`, that will parse the branches it </span>
<span class="sd">    gets from the queue and call the :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` function to add</span>
<span class="sd">    the commits</span>
<span class="sd">    </span>
<span class="sd">    :property logger: logger acquired by calling logging.getLogger(&quot;parser&quot;)</span>
<span class="sd">    </span>
<span class="sd">    :param queue: queue, where the different commithashes are stored in</span>
<span class="sd">    :param commitsToBeProcessed: dictionary, which contains information about the branches and tags of each commit</span>
<span class="sd">    :param repository: repository object of type :class:`pygit2.Repository`</span>
<span class="sd">    :param datastore: object, that is a subclass of :class:`pyvcsshark.datastores.basestore.BaseStore`</span>
<span class="sd">    :param lock: lock that is used, so that only one process at a time is calling the :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">commitsToBeProcessed</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">datastore</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span> <span class="o">=</span> <span class="n">commitsToBeProcessed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="n">datastore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;parser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
        
<div class="viewcode-block" id="CommitParserProcess.run"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The process gets a commit out of the queue and processes it.</span>
<span class="sd">        We use the poisonous pill technique here. Means, our queue has #Processes times &quot;None&quot; in it in the end.</span>
<span class="sd">        If a process encouters that None, he will stop and terminate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">nextTask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c"># If process pulls the poisoned pill, he exits</span>
            <span class="k">if</span><span class="p">(</span><span class="n">nextTask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">commitHash</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Oid</span><span class="p">(</span><span class="nb">hex</span><span class="o">=</span><span class="n">nextTask</span><span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">[</span><span class="n">commitHash</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parseCommit</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

               
            
        <span class="k">return</span></div>
    
<div class="viewcode-block" id="CommitParserProcess.parseCommit"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.parseCommit">[docs]</a>    <span class="k">def</span> <span class="nf">parseCommit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function for parsing a commit.</span>
<span class="sd">        </span>
<span class="sd">        1. changedFiles are created (type: list of :class:`pyvcsshark.dbmodels.models.FileModel`)</span>
<span class="sd">        2. author and commiter are created (type: :class:`pyvcsshark.dbmodels.models.PeopleModel`)</span>
<span class="sd">        3. parents are added (list of strings)</span>
<span class="sd">        4. commit model is created (type: :class:`pyvcsshark.dbmodels.models.CommitModel`)</span>
<span class="sd">        5. :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` is called</span>
<span class="sd">        </span>
<span class="sd">        :param commit: commit object of type :class:`pygit2.Commit`</span>
<span class="sd">        </span>
<span class="sd">        .. NOTE:: The call to :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` is thread/process safe, as a lock is used to regulate the calls</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># If there are parents, we need to get the normal changed files, if not we need to get the files for initial commit</span>
        <span class="k">if</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">):</span>
            <span class="n">changedFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChangedFilesWithSimiliarity</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">commit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">changedFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChangedFilesForInitialCommit</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
            
        <span class="n">strCommitHash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c"># Create the different models</span>
        <span class="n">authorModel</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">committerModel</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">parentIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">parentId</span><span class="p">)</span> <span class="k">for</span> <span class="n">parentId</span> <span class="ow">in</span> <span class="n">commit</span><span class="o">.</span><span class="n">parent_ids</span><span class="p">]</span>
                 
                 
        
        <span class="n">commitModel</span> <span class="o">=</span> <span class="n">CommitModel</span><span class="p">(</span><span class="n">strCommitHash</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">strCommitHash</span><span class="p">][</span><span class="s">&#39;branches&#39;</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">strCommitHash</span><span class="p">][</span><span class="s">&#39;tags&#39;</span><span class="p">],</span> <span class="n">parentIds</span><span class="p">,</span>
                                  <span class="n">authorModel</span><span class="p">,</span> <span class="n">committerModel</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">changedFiles</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                                  <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="c"># Make sure, that addCommit is only called by one process at a time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span><span class="o">.</span><span class="n">addCommit</span><span class="p">(</span><span class="n">commitModel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">commitsToBeProcessed</span><span class="p">[</span><span class="n">strCommitHash</span><span class="p">]</span></div>
  
    
<div class="viewcode-block" id="CommitParserProcess.createDiffInUnifiedFormat"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.createDiffInUnifiedFormat">[docs]</a>    <span class="k">def</span> <span class="nf">createDiffInUnifiedFormat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hunks</span><span class="p">,</span> <span class="n">initialCommit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the diff in the unified format (see: https://en.wikipedia.org/wiki/Diff#Unified_format)</span>
<span class="sd">        </span>
<span class="sd">        If we have the initial commit, we need to turn around the hunk.* attributes.</span>
<span class="sd">        </span>
<span class="sd">        :param hunks: list of objects of class :class:`pygit2.DiffHunk`</span>
<span class="sd">        :param initialCommit: indicates if we have an initial commit</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">listOfHunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">hunk</span> <span class="ow">in</span> <span class="n">hunks</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">initialCommit</span><span class="p">):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;@@ -</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s"> +</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s"> @@ </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hunk</span><span class="o">.</span><span class="n">new_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_lines</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_lines</span><span class="p">)</span>     
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hunk</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;@@ -</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s"> +</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s"> @@ </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hunk</span><span class="o">.</span><span class="n">old_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_lines</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_lines</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hunk</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>     
            
            <span class="n">listOfHunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">listOfHunks</span></div>
            

<div class="viewcode-block" id="CommitParserProcess.getModeForFile"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.getModeForFile">[docs]</a>    <span class="k">def</span> <span class="nf">getModeForFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parentTree</span><span class="p">,</span> <span class="n">childTree</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">similarity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets the mode for a file.</span>
<span class="sd">        C = Copied/Moved (if similiarity is greater than threshold)</span>
<span class="sd">        A = Added (if file is not in parenttree, but in child tree)</span>
<span class="sd">        D = Deleted (if file is in parent tree, but not in child tree)</span>
<span class="sd">        M = Modified (otherwise)</span>
<span class="sd">        </span>
<span class="sd">        :param parentTree: object of type :class:`pygit2.Tree` of the parent commit</span>
<span class="sd">        :param childTree: object of type :class:`pygit2.Tree` of the child commit</span>
<span class="sd">        :param path: path to the file that is analyzed</span>
<span class="sd">        :param similarity: similarity of the two files in both trees</span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="k">if</span><span class="p">(</span><span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">GitParser</span><span class="o">.</span><span class="n">SIMILARITY_THRESHOLD</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;C&#39;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parentTree</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">childTree</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;A&#39;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">path</span> <span class="ow">in</span> <span class="n">parentTree</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">childTree</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;D&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;M&#39;</span></div>
        

<div class="viewcode-block" id="CommitParserProcess.getChangedFilesForInitialCommit"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.getChangedFilesForInitialCommit">[docs]</a>    <span class="k">def</span> <span class="nf">getChangedFilesForInitialCommit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Special function for the initial commit, as we need to diff against the empty tree. Creates</span>
<span class="sd">        the changed files list, where objects of class :class:`pyvcsshark.dbmodels.models.FileModel` are added.</span>
<span class="sd">        For every changed file in the initial commit.</span>
<span class="sd">        </span>
<span class="sd">        :param commit: commit of type :class:`pygit2.Commit`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">changedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">diff_to_tree</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
            <span class="n">changedFile</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                    <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">is_binary</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">createDiffInUnifiedFormat</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">hunks</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
            <span class="n">changedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changedFile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changedFiles</span></div>
        
        
<div class="viewcode-block" id="CommitParserProcess.getChangedFilesWithSimiliarity"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.getChangedFilesWithSimiliarity">[docs]</a>    <span class="k">def</span> <span class="nf">getChangedFilesWithSimiliarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot; Creates a list of changed files of the class :class:`pyvcsshark.dbmodels.models.FileModel`. For every</span>
<span class="sd">        changed file in the commit such an object is created. Furthermore, hunks are saved an each file is tested for similarity to</span>
<span class="sd">        detect copy and move operations</span>
<span class="sd">        </span>
<span class="sd">        :param parent: Object of class :class:`pygit2.Commit`, that represents the parent commit</span>
<span class="sd">        :param commit: Object of class :class:`pygit2.Commit`, that represents the child commit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">changedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
                            
        <span class="n">opts</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_DIFF_FIND_RENAMES</span> <span class="o">|</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_DIFF_FIND_COPIES</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">find_similar</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">GitParser</span><span class="o">.</span><span class="n">SIMILARITY_THRESHOLD</span><span class="p">,</span> <span class="n">GitParser</span><span class="o">.</span><span class="n">SIMILARITY_THRESHOLD</span><span class="p">)</span>
                    
        <span class="c"># We need to check for mode &quot;T&quot; for files. We have this mode, if there are &gt;1 patches, which affect the same file</span>
        <span class="c"># Therefore, we first need to check, which file is there more than once</span>
        <span class="n">filePaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">filePaths</span><span class="p">)</span>

        <span class="n">alreadyCheckedFilePaths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
            
            <span class="c"># Only if the filepath was not processed before, add new file</span>
            <span class="k">if</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="n">alreadyCheckedFilePaths</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;T&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getModeForFile</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">similarity</span><span class="p">)</span>
                
            
            <span class="n">changedFile</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                    <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">is_binary</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">createDiffInUnifiedFormat</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">hunks</span><span class="p">))</span>
            
            <span class="c"># only add oldpath if file was copied/renamed</span>
            <span class="k">if</span><span class="p">(</span><span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">):</span>
                <span class="n">changedFile</span><span class="o">.</span><span class="n">oldPath</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">path</span>
    
            <span class="n">alreadyCheckedFilePaths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">changedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changedFile</span><span class="p">)</span>
            
            
        <span class="k">return</span> <span class="n">changedFiles</span>   </div></div>


    
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Fabian Trautsch.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>